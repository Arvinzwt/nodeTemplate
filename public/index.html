<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>websocket</title>
</head>
<body>
    <label for="loginInput">
        <input type="text" id="loginInput"/>
        <button id="loginBtn">登录</button>
    </label>

    <label for="otherUsernameInput">
        <input type="text" id="otherUsernameInput"/>
        <button id="connectToOtherUsernameBtn">建立连接</button>
    </label>
</body>
<script>
    const connection = new WebSocket("ws://localhost:8080");//地址为服务器接口地址
    const loginInput = document.querySelector("#loginInput");
    const loginBtn = document.querySelector("#loginBtn");
    const otherUsernameInput = document.querySelector("#otherUsernameInput");
    const connectToOtherUsernameBtn = document.querySelector("#connectToOtherUsernameBtn");
    let connectedUser, myConnection;

    loginBtn.addEventListener('click', evt => {
        let name = loginInput.value;
        if (name.length > 0) {
            send({
                type: 'login',
                name: name,
            })
        }else {
            alert('请输入登录内容')
        }
    })

    connection.onopen = () => { // 连接成功时
        console.log('连接websocket成功')
    };

    connection.onmessage = (evt) => { // 发送信息时
        let data = JSON.parse(evt.data);

        switch (data.type) {
            case "login":
                onLogin(data.success);
                break;
            case "offer":
                onOffer(data.offer, data.name);
                break;
            case "answer":
                onAnswer(data.answer);
                break;
            case "candidate":
                onCandidate(data.candidate);
                break;
            default:
                break;
        }
    };

    connection.onclose = () => { // 关闭连接时
        console.log('关闭websocket')
    };

    connection.onerror = (err) => {  // 连接错误时
        console.log('连接websocket失败', err)
    }

    function onLogin(success) {
        if (success === false) {
            alert("登录失败");
        } else {
            const configuration = {
                "iceServers": [{"urls": "stun:stun.l.google.com:19302"}]
            };

            myConnection = new RTCPeerConnection(configuration)

            myConnection.onicecandidate = event => {
                if (event.candidate) {
                    send({
                        type: "candidate",
                        candidate: event.candidate
                    });
                }else {
                    console.log('失败')
                }
            }
        }
    }

    function send(message){
        if (connectedUser) {
            message.name = connectedUser;
        }

        connection.send(JSON.stringify(message));
    }

</script>
</html>